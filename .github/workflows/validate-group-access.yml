name: üîí Validaci√≥n de Acceso por Grupos

on:
  push:
    branches:
      - 'feature_Grupo*'
  pull_request:
    branches:
      - develop
      - main
    types: [opened, synchronize, reopened]

jobs:
  validate-group-access:
    runs-on: ubuntu-latest
    name: Validar acceso de grupos a carpetas
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üîç Validar estructura de carpetas y permisos
      run: |
        # Obtener la rama actual
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BRANCH_NAME="${{ github.head_ref }}"
        else
          BRANCH_NAME="${{ github.ref_name }}"
        fi
        
        echo "üîç Validando rama: $BRANCH_NAME"
        
        # Definir mapeo de ramas a carpetas
        declare -A branch_folders=(
          ["feature_Grupo1_AutoevaluacionMidas"]="AutoevaluacionMidas"
          ["feature_Grupo2_BitacoraAsistidaCefalea"]="BitacoraAsistidaCefalea"
          ["feature_Grupo3_AutoevaluacionMidas"]="AutoevaluacionMidas"
          ["feature_Grupo4_Recordatorios"]="Recordatorios"
          ["feature_Grupo5_AgendamientoCitasMedicas"]="AgendamientoCitasMedicas"
          ["feature_Grupo6_AnalisisPatronesClinicos"]="AnalisisPatronesClinicos"
          ["feature_Grupo7_GeneracionSeguimientoTratamiento"]="GeneracionSeguimientoTratamiento"
        )
        
        # Verificar si es una rama de feature v√°lida
        if [[ ! "$BRANCH_NAME" =~ ^feature_Grupo[0-9]_ ]]; then
          echo "‚ö†Ô∏è Rama $BRANCH_NAME no es una rama de feature de grupo"
          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "develop" ]]; then
            echo "‚úÖ Rama principal - permitida para l√≠deres t√©cnicos"
            exit 0
          else
            echo "‚ùå Rama no reconocida"
            exit 1
          fi
        fi
        
        # Obtener carpeta permitida
        ALLOWED_FOLDER="${branch_folders[$BRANCH_NAME]}"
        if [[ -z "$ALLOWED_FOLDER" ]]; then
          echo "‚ùå No se encontr√≥ configuraci√≥n para la rama: $BRANCH_NAME"
          exit 1
        fi
        
        echo "üìÅ Carpeta permitida: $ALLOWED_FOLDER"
        
        # Obtener archivos modificados
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "üìù Archivos modificados:"
        echo "$CHANGED_FILES"
        
        # Validar cada archivo
        INVALID_FILES=()
        while IFS= read -r file; do
          if [[ -n "$file" ]]; then
            # Verificar si el archivo est√° en las carpetas permitidas
            if [[ ! "$file" =~ ^(frontend|backend)/$ALLOWED_FOLDER/ ]] && \
               [[ ! "$file" =~ ^GRUPO_[0-9]+_README\.md$ ]] && \
               [[ ! "$file" =~ ^\.github/ ]] && \
               [[ ! "$file" =~ ^docs/ ]] && \
               [[ "$file" != "README.md" ]]; then
              INVALID_FILES+=("$file")
            fi
          fi
        done <<< "$CHANGED_FILES"
        
        # Reportar resultados
        if [[ ${#INVALID_FILES[@]} -gt 0 ]]; then
          echo "‚ùå VALIDACI√ìN FALLIDA"
          echo "Los siguientes archivos NO est√°n en las carpetas permitidas:"
          for file in "${INVALID_FILES[@]}"; do
            echo "   ‚ùå $file"
          done
          echo ""
          echo "üìÅ Carpetas permitidas para $BRANCH_NAME:"
          echo "   ‚úÖ frontend/$ALLOWED_FOLDER/"
          echo "   ‚úÖ backend/$ALLOWED_FOLDER/"
          echo "   ‚úÖ GRUPO_*_README.md"
          echo "   ‚úÖ .github/ (configuraci√≥n)"
          echo "   ‚úÖ docs/ (documentaci√≥n)"
          echo "   ‚úÖ README.md (ra√≠z)"
          echo ""
          echo "üîß Soluci√≥n:"
          echo "   1. Mueve tus archivos a las carpetas permitidas"
          echo "   2. O contacta al l√≠der t√©cnico para permisos especiales"
          exit 1
        fi
        
        echo "‚úÖ VALIDACI√ìN EXITOSA"
        echo "Todos los archivos est√°n en las ubicaciones correctas"

    - name: üìä Generar reporte de validaci√≥n
      if: always()
      run: |
        GROUP_NUM=$(echo "${{ github.ref_name }}" | grep -o 'Grupo[0-9]' | grep -o '[0-9]')
        echo "## üìã Reporte de Validaci√≥n - Grupo $GROUP_NUM" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Rama:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "‚úÖ **Estado:** Validaci√≥n exitosa" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Estado:** Validaci√≥n fallida" >> $GITHUB_STEP_SUMMARY
        fi
